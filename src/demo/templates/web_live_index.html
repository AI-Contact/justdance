<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹ ì‹¤ì‹œê°„ í¬ì¦ˆ ë¹„êµ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        .upload-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-danger {
            background: #f56565;
            color: white;
        }
        .btn-danger:hover {
            background: #e53e3e;
        }
        .video-container {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
            display: none;
        }
        .video-container.active {
            display: block;
        }
        #videoFeed {
            width: 100%;
            height: auto;
            display: block;
        }
        .status-bar {
            background: #e6f2ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        .status-bar.active {
            display: block;
        }
        .status-item {
            display: inline-block;
            margin-right: 20px;
            font-weight: 600;
        }
        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        .alert.show {
            display: block;
        }
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #38a169;
        }
        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #e53e3e;
        }
        .help-text {
            font-size: 0.875rem;
            color: #718096;
            margin-top: 5px;
        }
        .controls {
            text-align: center;
            margin-top: 20px;
        }
        /* ëŒ€í˜• ë“±ê¸‰ í‘œì‹œ */
        .grade-display-big {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            animation: gradePopIn 0.3s ease-out;
        }
        .grade-badge {
            font-size: 8rem;
            font-weight: bold;
            padding: 40px 80px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-shadow: 0 0 30px currentColor;
            animation: gradePulse 0.5s ease-in-out;
        }
        .grade-badge.PERFECT {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
        }
        .grade-badge.GOOD {
            background: linear-gradient(135deg, #00FF00, #00CC00);
            color: white;
        }
        .grade-badge.BAD {
            background: linear-gradient(135deg, #FF0000, #CC0000);
            color: white;
        }
        @keyframes gradePopIn {
            from {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        @keyframes gradePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        /* REST ìƒíƒœ í‘œì‹œ */
        .rest-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 998;
            animation: fadeIn 0.3s ease-out;
        }
        .rest-badge {
            font-size: 6rem;
            font-weight: bold;
            padding: 40px 80px;
            border-radius: 30px;
            background: linear-gradient(135deg, #87CEEB, #4682B4);
            color: white;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        }
        /* ìµœì¢… ê²°ê³¼ ëª¨ë‹¬ */
        .result-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s;
        }
        .result-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .result-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            animation: slideUp 0.5s;
        }
        .rank-display {
            font-size: 5rem;
            font-weight: bold;
            margin: 20px 0;
        }
        .rank-S { color: #FFD700; text-shadow: 0 0 20px #FFD700; }
        .rank-A { color: #00FF00; text-shadow: 0 0 20px #00FF00; }
        .rank-B { color: #00BFFF; text-shadow: 0 0 20px #00BFFF; }
        .rank-C { color: #FFA500; text-shadow: 0 0 20px #FFA500; }
        .rank-F { color: #FF0000; text-shadow: 0 0 20px #FF0000; }
        .grade-breakdown {
            margin: 20px 0;
            text-align: left;
        }
        .grade-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            font-size: 1.1rem;
        }
        .grade-item span:first-child {
            flex: 0 0 auto;
        }
        .grade-item span:last-child {
            flex: 0 0 auto;
            font-weight: bold;
            margin-left: 40px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ ì›¹ìº  ì‹¤ì‹œê°„ í¬ì¦ˆ ë¹„êµ</h1>

        <div id="alertBox" class="alert"></div>

        <div class="upload-section">
            <h2 style="margin-bottom: 15px;">íŒŒì¼ ì—…ë¡œë“œ</h2>
            <div class="form-group">
                <label>ë ˆí¼ëŸ°ìŠ¤ ì„ë² ë”© (.npy) *</label>
                <input type="file" id="refEmbedding" accept=".npy" required>
                <p class="help-text">extract.pyë¡œ ìƒì„±í•œ ë ˆí¼ëŸ°ìŠ¤ ì„ë² ë”© íŒŒì¼</p>
            </div>

            <div class="form-group">
                <label>ë ˆí¼ëŸ°ìŠ¤ ëœë“œë§ˆí¬ (.npy) *</label>
                <input type="file" id="refLandmarks" accept=".npy" required>
                <p class="help-text">ë ˆí¼ëŸ°ìŠ¤ ëœë“œë§ˆí¬ ë°°ì—´ íŒŒì¼</p>
            </div>

            <div class="form-group">
                <label>ë ˆí¼ëŸ°ìŠ¤ ì˜ìƒ (video) *</label>
                <input type="file" id="refVideo" accept="video/*" required>
                <p class="help-text">ê°€ì´ë“œ ì˜ìƒ íŒŒì¼ (ìš°ì¸¡ì— í‘œì‹œë¨)</p>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="startBtn">â–¶ ì›¹ìº  ë¹„êµ ì‹œì‘</button>
                <button class="btn btn-danger" id="stopBtn" style="display: none;">â¹ ì¤‘ì§€</button>
            </div>
        </div>

        <div class="status-bar" id="statusBar">
            <span class="status-item">ì ìˆ˜: <span id="statusScore">-</span>%</span>
            <span class="status-item">ìƒíƒœ: <span id="statusRunning">ëŒ€ê¸° ì¤‘</span></span>
        </div>

        <!-- ëŒ€í˜• ë“±ê¸‰ í‘œì‹œ (ì¼ì‹œì ) -->
        <div class="grade-display-big" id="gradeDisplayBig" style="display: none;">
            <div class="grade-badge" id="gradeBadge">-</div>
        </div>

        <!-- REST ìƒíƒœ í‘œì‹œ -->
        <div class="rest-display" id="restDisplay" style="display: none;">
            <div class="rest-badge">ì‰¬ëŠ” ì‹œê°„</div>
        </div>

        <!-- ë ˆí¼ëŸ°ìŠ¤ ë¹„ë””ì˜¤ ì˜¤ë””ì˜¤ ì¬ìƒìš© (ìˆ¨ê¹€) -->
        <video id="refAudio" style="display: none;" preload="auto"></video>

        <div class="status-bar" id="gradeStatsBar" style="display: none; margin-top: 10px; background: #fff3cd;">
            <span class="status-item">ğŸ† PERFECT: <span id="perfectCount">0</span></span>
            <span class="status-item">âœ… GOOD: <span id="goodCount">0</span></span>
            <span class="status-item">âŒ BAD: <span id="badCount">0</span></span>
            <span class="status-item">ì´ í‰ê°€: <span id="totalGraded">0</span>íšŒ</span>
        </div>

        <div class="video-container" id="videoContainer">
            <img id="videoFeed" src="" alt="ë¹„êµ ì˜ìƒ">
        </div>
    </div>

    <!-- ìµœì¢… ê²°ê³¼ ëª¨ë‹¬ -->
    <div class="result-modal" id="resultModal">
        <div class="result-content">
            <h2>ğŸ‰ ìš´ë™ ì™„ë£Œ!</h2>
            <div class="rank-display" id="finalRank">-</div>
            <h3>ì„±ì í‘œ</h3>
            <div class="grade-breakdown">
                <div class="grade-item">
                    <span>ğŸ† PERFECT</span>
                    <span id="finalPerfect">0 (0%)</span>
                </div>
                <div class="grade-item">
                    <span>âœ… GOOD</span>
                    <span id="finalGood">0 (0%)</span>
                </div>
                <div class="grade-item">
                    <span>âŒ BAD</span>
                    <span id="finalBad">0 (0%)</span>
                </div>
                <div class="grade-item" style="border-bottom: none; font-weight: bold;">
                    <span>ì´ í‰ê°€</span>
                    <span id="finalTotal">0íšŒ</span>
                </div>
            </div>
            <button class="btn btn-primary" onclick="closeResultModal()" style="margin-top: 20px;">í™•ì¸</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
    <script>
        let isRunning = false;
        let statusInterval = null;
        let uploadedPaths = null;
        let lastGradeTimestamp = 0;
        let gradeHideTimer = null;
        let finalResultShown = false; // ìµœì¢… ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ ì—¬ë¶€ í”Œë˜ê·¸
        let refAudioElement = null; // ë ˆí¼ëŸ°ìŠ¤ ì˜¤ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸
        let wasInWarmup = false; // ì´ì „ warmup ìƒíƒœ

        // Web Audio API ì´ˆê¸°í™” (ë¹„í”„ìŒìš©)
        let audioContext = null;
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // ë¹„í”„ìŒ ì¬ìƒ
        function playBeep(frequency, duration) {
            if (!audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = 'square';  // 'sine' â†’ 'square' (ë” ì„ ëª…í•˜ê³  ê°•í•œ ì†Œë¦¬)
            // ë‹¤ë¥¸ ì˜µì…˜: 'triangle', 'sawtooth'

            // ë³¼ë¥¨ ì¦ê°€ (0.3 â†’ 0.6) ë° ë¹ ë¥¸ í˜ì´ë“œì•„ì›ƒ
            gainNode.gain.setValueAtTime(0.6, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }


        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(message, type = 'success') {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} show`;
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        // íŒŒì¼ ì—…ë¡œë“œ
        async function uploadFiles() {
            const refEmb = document.getElementById('refEmbedding').files[0];
            const refLm = document.getElementById('refLandmarks').files[0];
            const refVid = document.getElementById('refVideo').files[0];

            if (!refEmb || !refLm || !refVid) {
                showAlert('í•„ìˆ˜ íŒŒì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return null;
            }

            const formData = new FormData();
            formData.append('ref_embedding', refEmb);
            formData.append('ref_landmarks', refLm);
            formData.append('ref_video', refVid);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    return data;
                } else {
                    showAlert(data.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨', 'error');
                    return null;
                }
            } catch (error) {
                showAlert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
                return null;
            }
        }

        // ì„¸ì…˜ ì‹œì‘
        async function startSession() {
            if (!uploadedPaths) {
                uploadedPaths = await uploadFiles();
                if (!uploadedPaths) return;
            }

            // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” (ì‚¬ìš©ì ì œìŠ¤ì²˜ í•„ìš”)
            initAudio();

            const payload = {
                ref_path: uploadedPaths.ref_path,
                ref_lm_path: uploadedPaths.ref_lm_path,
                ref_video_path: uploadedPaths.ref_video_path,
            };

            try {
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (data.success) {
                    isRunning = true;
                    finalResultShown = false; // ìƒˆ ì„¸ì…˜ ì‹œì‘ ì‹œ í”Œë˜ê·¸ ì´ˆê¸°í™”
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-block';
                    document.getElementById('videoContainer').classList.add('active');
                    document.getElementById('statusBar').classList.add('active');
                    // ë“±ê¸‰ í†µê³„ë°”ëŠ” ìµœì¢… ê²°ê³¼ì—ì„œë§Œ í‘œì‹œ
                    document.getElementById('gradeStatsBar').style.display = 'none';

                    // ë¹„ë””ì˜¤ í”¼ë“œ URL ì„¤ì •
                    const videoFeed = document.getElementById('videoFeed');
                    videoFeed.src = '/video_feed?' + new Date().getTime();
                    videoFeed.onerror = function() {
                        console.error('ë¹„ë””ì˜¤ í”¼ë“œ ë¡œë”© ì‹¤íŒ¨');
                        showAlert('ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    };
                    videoFeed.onload = function() {
                        console.log('ë¹„ë””ì˜¤ í”¼ë“œ ë¡œë”© ì„±ê³µ');
                    };

                    // ë ˆí¼ëŸ°ìŠ¤ ë¹„ë””ì˜¤ ì˜¤ë””ì˜¤ ì„¤ì •
                    refAudioElement = document.getElementById('refAudio');
                    refAudioElement.src = '/api/ref_video?' + new Date().getTime();
                    refAudioElement.volume = 0.7; // ë³¼ë¥¨ 70%
                    refAudioElement.muted = false; // ìŒì†Œê±° í•´ì œ

                    // ì˜¤ë””ì˜¤ ë¡œë“œ ë° ì¤€ë¹„
                    try {
                        await refAudioElement.load();
                        console.log('ë ˆí¼ëŸ°ìŠ¤ ì˜¤ë””ì˜¤ ë¡œë“œ ì™„ë£Œ');

                        // ë¸Œë¼ìš°ì € ìë™ì¬ìƒ ì •ì±… ìš°íšŒ: ì§§ê²Œ ì¬ìƒ í›„ ì¦‰ì‹œ ì¼ì‹œì •ì§€
                        const playPromise = refAudioElement.play();
                        if (playPromise !== undefined) {
                            playPromise.then(() => {
                                console.log('ì˜¤ë””ì˜¤ ì–¸ë½ ì„±ê³µ');
                                refAudioElement.pause();
                                refAudioElement.currentTime = 0;
                            }).catch(err => {
                                console.warn('ì˜¤ë””ì˜¤ ì–¸ë½ ì‹¤íŒ¨:', err);
                            });
                        }
                    } catch (err) {
                        console.error('ì˜¤ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨:', err);
                    }

                    wasInWarmup = true; // warmup ì‹œì‘

                    // ìƒíƒœ í´ë§ ì‹œì‘
                    statusInterval = setInterval(updateStatus, 1000);

                    showAlert(data.message, 'success');
                } else {
                    showAlert(data.message || 'ì‹œì‘ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showAlert('ì„¸ì…˜ ì‹œì‘ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ì„¸ì…˜ ì¤‘ì§€
        async function stopSession() {
            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                const data = await response.json();

                isRunning = false;
                document.getElementById('startBtn').style.display = 'inline-block';
                document.getElementById('stopBtn').style.display = 'none';
                document.getElementById('videoContainer').classList.remove('active');
                document.getElementById('statusBar').classList.remove('active');
                document.getElementById('gradeStatsBar').style.display = 'none';
                document.getElementById('gradeDisplayBig').style.display = 'none';
                document.getElementById('restDisplay').style.display = 'none';

                // ë ˆí¼ëŸ°ìŠ¤ ì˜¤ë””ì˜¤ ì¤‘ì§€
                if (refAudioElement) {
                    refAudioElement.pause();
                    refAudioElement.currentTime = 0;
                    refAudioElement = null;
                }

                wasInWarmup = false; // warmup ìƒíƒœ ì´ˆê¸°í™”

                if (statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }

                if (gradeHideTimer) {
                    clearTimeout(gradeHideTimer);
                    gradeHideTimer = null;
                }

                lastGradeTimestamp = 0;
                finalResultShown = false; // í”Œë˜ê·¸ ì´ˆê¸°í™”

                showAlert(data.message || 'ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                uploadedPaths = null;  // ë‹¤ìŒ ì‹œì‘ ì‹œ ì¬ì—…ë¡œë“œ
            } catch (error) {
                showAlert('ì¤‘ì§€ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                console.log('Status update:', data); // ë””ë²„ê¹… ë¡œê·¸

                document.getElementById('statusScore').textContent = data.score ? data.score.toFixed(1) : '-';
                document.getElementById('statusRunning').textContent = data.is_running ? 'ì‹¤í–‰ ì¤‘' : 'ì¤‘ì§€ë¨';

                // ë“±ê¸‰ í†µê³„ ì—…ë°ì´íŠ¸ (ëˆ„ì  ì¹´ìš´íŠ¸ëŠ” ìˆ¨ê¹€ - ìµœì¢… ê²°ê³¼ì—ì„œë§Œ í‘œì‹œ)
                if (data.graded_total > 0) {
                    document.getElementById('perfectCount').textContent = data.grade_counts.PERFECT || 0;
                    document.getElementById('goodCount').textContent = data.grade_counts.GOOD || 0;
                    document.getElementById('badCount').textContent = data.grade_counts.BAD || 0;
                    document.getElementById('totalGraded').textContent = data.graded_total;
                }

                // ìƒˆë¡œìš´ ë“±ê¸‰ì´ ë§¤ê²¨ì¡Œì„ ë•Œë§Œ ì¼ì‹œì ìœ¼ë¡œ í‘œì‹œ (2ì´ˆ)
                if (data.current_grade && data.grade_timestamp > lastGradeTimestamp) {
                    lastGradeTimestamp = data.grade_timestamp;
                    showGradeBig(data.current_grade);
                }

                // REST ìƒíƒœ í‘œì‹œ
                const restDisplay = document.getElementById('restDisplay');
                if (data.is_rest) {
                    restDisplay.style.display = 'block';
                } else {
                    restDisplay.style.display = 'none';
                }

                // Warmup ì¢…ë£Œ ì‹œì  ê°ì§€ ë° ë ˆí¼ëŸ°ìŠ¤ ì˜¤ë””ì˜¤ ì¬ìƒ
                if (wasInWarmup && !data.is_warmup && refAudioElement && data.is_running) {
                    console.log('Warmup ì¢…ë£Œ - ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œì‘');
                    console.log('ì˜¤ë””ì˜¤ ìƒíƒœ:', {
                        paused: refAudioElement.paused,
                        currentTime: refAudioElement.currentTime,
                        volume: refAudioElement.volume,
                        muted: refAudioElement.muted,
                        readyState: refAudioElement.readyState
                    });

                    refAudioElement.currentTime = 0;
                    refAudioElement.muted = false;
                    refAudioElement.volume = 0.7;

                    const playPromise = refAudioElement.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('âœ… ì˜¤ë””ì˜¤ ì¬ìƒ ì„±ê³µ!');
                        }).catch(err => {
                            console.error('âŒ ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', err);
                            showAlert('ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨: ' + err.message + '. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
                        });
                    }
                }
                wasInWarmup = data.is_warmup;

                // ì„¸ì…˜ ì¢…ë£Œ ì‹œ ìµœì¢… ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ (í•œ ë²ˆë§Œ)
                if (data.session_ended && data.final_rank && !finalResultShown) {
                    console.log('Session ended, showing final result:', data.final_rank);
                    finalResultShown = true; // í”Œë˜ê·¸ ì„¤ì •í•˜ì—¬ ì¬í‘œì‹œ ë°©ì§€
                    showFinalResult(data);
                }

                // ë¹„í”„ìŒ ì¬ìƒ
                if (data.beep && audioContext) {
                    playBeep(data.beep.frequency, data.beep.duration);
                }

                if (!data.is_running && isRunning) {
                    // ìë™ ì¢…ë£Œë¨
                    console.log('Session stopped automatically');
                    stopSession();
                }
            } catch (error) {
                console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ëŒ€í˜• ë“±ê¸‰ í‘œì‹œ (2ì´ˆê°„)
        function showGradeBig(grade) {
            const displayBig = document.getElementById('gradeDisplayBig');
            const badge = document.getElementById('gradeBadge');

            // ì´ì „ íƒ€ì´ë¨¸ ì·¨ì†Œ
            if (gradeHideTimer) {
                clearTimeout(gradeHideTimer);
            }

            // ë“±ê¸‰ ì„¤ì •
            badge.textContent = grade;
            badge.className = `grade-badge ${grade}`;

            // í‘œì‹œ
            displayBig.style.display = 'block';

            // 2ì´ˆ í›„ ìë™ ìˆ¨ê¹€
            gradeHideTimer = setTimeout(() => {
                displayBig.style.display = 'none';
            }, 2000);
        }

        // ìµœì¢… ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
        function showFinalResult(data) {
            console.log('showFinalResult called with:', data);

            const modal = document.getElementById('resultModal');
            const rankDisplay = document.getElementById('finalRank');

            if (!modal || !rankDisplay) {
                console.error('Modal elements not found!');
                return;
            }

            // ë­í¬ì— ë”°ë¼ ìƒ‰ìƒ ì ìš©
            rankDisplay.textContent = data.final_rank;
            rankDisplay.className = `rank-display rank-${data.final_rank}`;

            // í†µê³„ í‘œì‹œ (ë¹„ìœ¨ë§Œ)
            const total = data.graded_total || 1; // 0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ë°©ì§€
            const pCnt = data.grade_counts.PERFECT || 0;
            const gCnt = data.grade_counts.GOOD || 0;
            const bCnt = data.grade_counts.BAD || 0;

            document.getElementById('finalPerfect').textContent = `${(pCnt/total*100).toFixed(1)}%`;
            document.getElementById('finalGood').textContent = `${(gCnt/total*100).toFixed(1)}%`;
            document.getElementById('finalBad').textContent = `${(bCnt/total*100).toFixed(1)}%`;
            document.getElementById('finalTotal').textContent = `${total}íšŒ`;

            // ë“±ê¸‰ í†µê³„ë°”ë„ í‘œì‹œ
            document.getElementById('gradeStatsBar').style.display = 'block';

            modal.classList.add('show');
            console.log('Modal displayed');
        }

        // ìµœì¢… ê²°ê³¼ ëª¨ë‹¬ ë‹«ê¸°
        function closeResultModal() {
            document.getElementById('resultModal').classList.remove('show');
            finalResultShown = false; // í”Œë˜ê·¸ ì´ˆê¸°í™” (ì¬ì‹œì‘ ì‹œ ë‹¤ì‹œ í‘œì‹œ ê°€ëŠ¥í•˜ë„ë¡)
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('startBtn').addEventListener('click', startSession);
        document.getElementById('stopBtn').addEventListener('click', stopSession);
    </script>
</body>
</html>

